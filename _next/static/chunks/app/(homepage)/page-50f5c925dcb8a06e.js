(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[424],{22217:()=>{},75993:()=>{},41713:()=>{},1048:()=>{},67940:(e,t,a)=>{Promise.resolve().then(a.bind(a,25206))},25206:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>N});var s=a(95155),r=a(12115),l=a(71041),n=a(37873),i=a(2818);new n.YE({token:i.env.NEXT_PUBLIC_COZE_TOKEN,allowPersonalAccessTokenInBrowser:!0,baseURL:n.SI});let o=async e=>{try{let t=new FormData;t.append("file",e);let a=await fetch("https://api.coze.cn/v1/files/upload",{method:"POST",headers:{Authorization:"Bearer ".concat(i.env.NEXT_PUBLIC_COZE_TOKEN)},body:t});if(!a.ok){let e=await a.json();throw Error(e.error_message||"文件上传失败")}let{file_id:s}=await a.json();return s}catch(a){let t="未知错误";throw a instanceof Error&&(t=a.message),console.error("上传失败详情:",{fileName:e.name,size:e.size,type:e.type,error:t}),Error("文件上传失败: ".concat(t))}},c=async(e,t,a,s)=>{var r,l,n;let o=await fetch("https://api.coze.cn/v1/workflow/stream_run",{method:"POST",headers:{Authorization:"Bearer ".concat(i.env.NEXT_PUBLIC_COZE_TOKEN),"Content-Type":"application/json"},body:JSON.stringify({workflow_id:e,parameters:t})});if(!o.ok)throw Error((await o.json()).error_message||"请求失败: ".concat(o.status));let c=null===(r=o.body)||void 0===r?void 0:r.getReader(),d=new TextDecoder,m="";try{for(;c;){let{done:e,value:t}=await c.read();if(e)break;let r=(m+=d.decode(t,{stream:!0})).split(/\n\n/);for(let e of(m=r.pop()||"",r)){let t=e.split(/\n/),r={id:-1,event:"Done",data:null};for(let e of t)if(e.startsWith("id:"))r.id=parseInt(e.split(": ")[1]);else if(e.startsWith("event:"))r.event=e.split(": ")[1];else if(e.startsWith("data:"))try{r.data=JSON.parse(e.slice(5))}catch(e){console.error("JSON解析错误:",e)}switch(r.event){case"Message":(null===(l=r.data)||void 0===l?void 0:l.content)&&a(r.data.content);break;case"Error":null==s||s((null===(n=r.data)||void 0===n?void 0:n.error_message)||"未知错误");break;case"Interrupt":null==s||s("工作流被中断")}}}}catch(e){throw console.error("流处理错误:",e),e}},d=async()=>{try{await fetch("https://api.coze.cn/v1/files/upload",{headers:{Authorization:"Bearer ".concat(i.env.NEXT_PUBLIC_COZE_TOKEN)}}),await fetch("https://api.coze.cn/v1/workflow/stream_run",{method:"POST",headers:{Authorization:"Bearer ".concat(i.env.NEXT_PUBLIC_COZE_TOKEN),"Content-Type":"application/json"},body:JSON.stringify({workflow_id:!i.env.NEXT_PUBLIC_BOT})})}catch(e){throw console.error("权限验证失败，请检查："),console.error("1. 令牌是否已开启所需权限"),console.error("2. 环境变量NEXT_PUBLIC_COZE_TOKEN是否正确"),console.error("3. 令牌是否已过期"),e}},m=async e=>{try{var t;let a=await fetch("https://api.coze.cn/v1/files/retrieve?file_id=".concat(e),{headers:{Authorization:"Bearer ".concat(i.env.NEXT_PUBLIC_COZE_TOKEN)}});if(!a.ok){let e=await a.json();throw Error(e.msg||"获取文件详情失败")}let s=await a.json();if(!(null===(t=s.data)||void 0===t?void 0:t.file_name))throw Error("无效的文件详情响应格式");return s}catch(a){let t="未知错误";throw a instanceof Error&&(t=a.message),console.error("文件详情获取失败:",{fileId:e,error:t}),a}};var h=a(94206),u=a(64566),x=a(94569),p=a(54628);let f=e=>{let{onUpload:t,disabled:a}=e,[l,n]=(0,r.useState)(0),i=async e=>{var a;let s=null===(a=e.target.files)||void 0===a?void 0:a[0];if(s)try{let e=setInterval(()=>{n(e=>Math.min(e+20,90))},200);await t(s),clearInterval(e),n(100),setTimeout(()=>n(0),1e3)}catch(e){e instanceof Error?alert(e.message):alert("An unknown error occurred")}finally{e.target.value=""}};return(0,s.jsx)("div",{className:"relative",children:(0,s.jsxs)("label",{className:"flex items-center justify-center w-10 h-10 rounded-md ".concat(a?"bg-gray-500":"bg-blue-500 hover:bg-blue-600"," transition-colors"),children:[(0,s.jsx)("input",{type:"file",className:"hidden",onChange:i,disabled:a,accept:"image/*,.pdf,.doc,.docx,.txt"}),l>0?(0,s.jsxs)("div",{className:"absolute inset-0 flex items-center justify-center",children:[(0,s.jsx)("div",{className:"absolute inset-0 bg-blue-500 rounded-md",style:{width:"".concat(l,"%")}}),(0,s.jsxs)("span",{className:"relative text-xs text-white",children:[l,"%"]})]}):(0,s.jsx)(p.A,{className:"w-5 h-5 text-white"})]})})};var g=a(689),v=a(41983),y=a(5565);let w=e=>{let{content:t,onRemove:a}=e,r=t.mimeType.startsWith("image/");return t.mimeType,(0,s.jsxs)("div",{className:"relative group border rounded-lg p-2 bg-gray-700 hover:bg-gray-600 transition-colors",children:[a&&(0,s.jsx)("button",{onClick:a,className:"absolute -top-2 -right-2 bg-red-500 rounded-full p-1 hover:bg-red-600 z-10","aria-label":"移除文件",children:(0,s.jsx)(g.A,{className:"w-4 h-4 text-white"})}),(0,s.jsxs)("div",{className:"flex flex-col items-center gap-2",children:[r?(0,s.jsx)(y.default,{src:t.url,alt:t.name,width:128,height:128,className:"h-32 w-32 object-cover rounded-md",style:{objectFit:"cover",borderRadius:"0.375rem"}}):(0,s.jsx)("div",{className:"w-32 h-32 bg-gray-800 rounded-md flex items-center justify-center",children:(0,s.jsx)(v.A,{className:"w-12 h-12 text-gray-400"})}),(0,s.jsx)("span",{className:"text-sm text-gray-300 truncate max-w-[120px]",children:t.name})]})]})};var b=a(22783),j=a(2818);function N(){var e;let{chatSessions:t,activeSessionId:a,addMessage:n}=(0,l.Y)(),[i,p]=(0,r.useState)(""),[g,v]=(0,r.useState)(!1),[y,N]=(0,r.useState)(""),[E,C]=(0,r.useState)([]),[T,O]=(0,r.useState)("checking...");(0,r.useEffect)(()=>{(async()=>{try{await d(),O("✅ 权限状态正常")}catch(t){let e="未知错误";"object"==typeof t&&null!==t&&"message"in t&&"string"==typeof t.message&&(e=t.message),O("❌ 权限错误: ".concat(e)),console.error("权限验证失败:",t)}})()},[]);let S=async()=>{if((i.trim()||0!==E.length)&&a&&!g)try{v(!0);let e=await Promise.all(E.map(async e=>{try{var t;let a=await o(e),s=await m(a);if(!(null===(t=s.data)||void 0===t?void 0:t.file_name)||!s.data.id)throw Error("文件信息不完整");return{fileId:a,detail:s,paramKey:e.type.startsWith("image/")?"image_input":"file_input",originalFile:e}}catch(a){console.error("文件处理失败:",e.name,a);let t=a instanceof Error?a.message:String(a);throw Error("文件 ".concat(e.name," 处理失败: ").concat(t))}})),t=e.reduce((e,t)=>(e[t.paramKey]=JSON.stringify({file_id:t.fileId}),e),{});t.text_input=i,e.forEach(e=>{let{detail:t,originalFile:s}=e;n(a,{role:"user",content:{type:"file",url:URL.createObjectURL(s),name:t.data.file_name,mimeType:s.type,meta:{id:t.data.id,size:t.data.bytes,uploadedAt:t.data.created_at}},timestamp:Date.now()})});let s="";await c(j.env.NEXT_PUBLIC_WORKFLOW_ID,t,e=>{N(t=>t+e),s+=e},e=>{throw Error(e)}),n(a,{role:"assistant",content:s,timestamp:Date.now()})}catch(e){n(a,{role:"assistant",content:"object"==typeof e&&null!==e&&"message"in e&&"string"==typeof e.message&&e.message.includes("file_name")?"文件处理失败：服务器返回格式异常":"object"==typeof e&&null!==e&&"message"in e&&"string"==typeof e.message?e.message:String(e),timestamp:Date.now()})}finally{p(""),C([]),v(!1),N("")}},k=e=>"string"==typeof e?(0,s.jsx)(h.oz,{components:{code:e=>{let{inline:t,children:a}=e,r=String(a).replace(/\n$/,"");return t?(0,s.jsx)("code",{className:"bg-gray-800 text-yellow-300 p-1 rounded",children:r}):(0,s.jsxs)("div",{className:"relative",children:[(0,s.jsx)(u.A,{language:"javascript",style:x.A,customStyle:{backgroundColor:"#2E3A4B",borderRadius:"8px"},children:r}),(0,s.jsx)(_,{code:r})]})},h1:e=>{let{children:t}=e;return(0,s.jsx)("h1",{className:"text-3xl font-bold mt-4 mb-2",children:t})},h2:e=>{let{children:t}=e;return(0,s.jsx)("h2",{className:"text-2xl font-semibold mt-4 mb-2",children:t})},h3:e=>{let{children:t}=e;return(0,s.jsx)("h3",{className:"text-xl font-medium mt-4 mb-2",children:t})},h4:e=>{let{children:t}=e;return(0,s.jsx)("h4",{className:"text-lg font-medium mt-4 mb-2",children:t})},h5:e=>{let{children:t}=e;return(0,s.jsx)("h5",{className:"text-md font-medium mt-4 mb-2",children:t})},h6:e=>{let{children:t}=e;return(0,s.jsx)("h6",{className:"text-sm font-medium mt-4 mb-2",children:t})}},children:e}):(0,s.jsx)(w,{content:e});return(0,s.jsxs)("div",{className:"p-4 bg-neutral-800 h-full w-full",children:[(0,s.jsx)("div",{className:"mb-4 p-3 bg-gray-700 rounded-lg",children:(0,s.jsxs)("div",{className:"text-sm flex items-center gap-2",children:[(0,s.jsx)("span",{children:"系统状态："}),(0,s.jsx)("span",{className:"font-medium ".concat(T.includes("✅")?"text-green-400":"text-red-400"),children:T})]})}),(0,s.jsxs)("div",{className:"p-4 bg-neutral-800 h-full max-w-[1000px] mx-auto",children:[(0,s.jsxs)("div",{className:"mb-4 h-[calc(100vh-520px)] overflow-y-auto space-y-4",children:[a&&(null===(e=t.find(e=>e.id===a))||void 0===e?void 0:e.messages.map((e,t)=>(0,s.jsxs)("div",{className:"p-4 rounded-lg ".concat("user"===e.role?"bg-blue-600 ml-auto max-w-[80%]":"bg-gray-700 max-w-[90%]"),children:[k(e.content),(0,s.jsx)("div",{className:"mt-2 text-xs text-gray-300",children:new Date(e.timestamp).toLocaleTimeString()})]},t))),g&&(0,s.jsxs)("div",{className:"p-4 rounded-lg bg-gray-700 max-w-[90%]",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2 text-gray-400",children:[(0,s.jsx)(b.A,{className:"animate-spin"}),"正在生成响应..."]}),y&&(0,s.jsx)("div",{className:"mt-2",children:(0,s.jsx)(h.oz,{children:y})}),T.startsWith("❌")&&(0,s.jsxs)("div",{className:"mt-2 text-red-400 text-sm",children:["操作被拒绝，请检查：",(0,s.jsxs)("ul",{className:"list-disc pl-4 mt-1",children:[(0,s.jsx)("li",{children:"访问令牌是否已过期"}),(0,s.jsx)("li",{children:"是否具有文件操作权限"}),(0,s.jsx)("li",{children:"工作流ID是否正确"})]})]})]})]}),(0,s.jsx)("div",{className:"flex gap-2 items-stretch",children:(0,s.jsxs)("div",{className:"flex flex-col gap-2 flex-1",children:[E.length>0&&(0,s.jsx)("div",{className:"flex gap-2 flex-wrap",children:E.map((e,t)=>(0,s.jsx)("div",{className:"relative",children:(0,s.jsx)(w,{content:{type:"file",url:URL.createObjectURL(e),name:e.name,mimeType:e.type},onRemove:()=>C(e=>e.filter((e,a)=>a!==t))})},t))}),(0,s.jsxs)("div",{className:"flex gap-2",children:[(0,s.jsx)(f,{onUpload:e=>(C(t=>[...t,e]),Promise.resolve("")),disabled:g}),(0,s.jsx)("input",{type:"text",value:i,onChange:e=>p(e.target.value),placeholder:"输入消息...",className:"flex-1 p-2 rounded-md bg-gray-700 text-white",onKeyDown:e=>"Enter"===e.key&&!e.shiftKey&&S(),disabled:g}),(0,s.jsx)("button",{onClick:S,className:"p-2 bg-blue-500 rounded-md text-white hover:bg-blue-600 disabled:opacity-50",disabled:g,children:g?(0,s.jsx)(b.A,{className:"animate-spin"}):"发送"})]})]})})]})]})}let _=e=>{let{code:t}=e,[a,l]=(0,r.useState)("Copy");return(0,s.jsx)("button",{onClick:()=>{navigator.clipboard.writeText(t).then(()=>{l("Copied!"),setTimeout(()=>l("Copy"),1500)})},className:"absolute top-2 right-2 bg-blue-500 text-white p-1 rounded w-[70px]",children:a})}},71041:(e,t,a)=>{"use strict";a.d(t,{ChatProvider:()=>n,Y:()=>i});var s=a(95155),r=a(12115);let l=(0,r.createContext)(void 0);function n(e){let{children:t}=e,[a,n]=(0,r.useState)([]),[i,o]=(0,r.useState)(null);(0,r.useEffect)(()=>{c()},[]);let c=()=>{let e={id:Date.now().toString(),createdAt:Date.now(),messages:[]};n(t=>[...t,e]),o(e.id)};return(0,r.useEffect)(()=>{let e=localStorage.getItem("chatSessions");e&&n(JSON.parse(e))},[]),(0,r.useEffect)(()=>{localStorage.setItem("chatSessions",JSON.stringify(a))},[a]),(0,s.jsx)(l.Provider,{value:{chatSessions:a,activeSessionId:i,createNewSession:c,addMessage:(e,t)=>{n(a=>a.map(a=>a.id===e?{...a,messages:[...a.messages,t]}:a))},setActiveSessionId:o},children:t})}let i=()=>{let e=(0,r.useContext)(l);if(!e)throw Error("useChat must be used within a ChatProvider");return e}}},e=>{var t=t=>e(e.s=t);e.O(0,[566,441,517,358],()=>t(67940)),_N_E=e.O()}]);